#!/bin/sh
set -eu

# Variables
NC='\033[0m' # No Color
Light_Green='\033[1;32m'  
STARTMSG="${Light_Green}[GENERATE_WEB_SERVER_CONFIGURATION]${NC}"
# Webserver Configuration
HTTP_CONF_DIRECTORY="/etc/apache2/sites-enabled"
HTTPS_FILE="${HTTP_CONF_DIRECTORY}/misp.ssl.conf"
HTTP_FILE="${HTTP_CONF_DIRECTORY}/misp.conf"

PORTS_FILE="/etc/apache2/ports.conf"

SERVER_STATUS_FILE="/etc/apache2/mods-enabled/server-status.conf"

MISP_FQDN=${MISP_FQDN:-"misp-server"}

SSL_CERT="/etc/apache2/ssl/cert.pem"
SSL_KEY="/etc/apache2/ssl/key.pem"
SSL_CA="/etc/apache2/ssl/ca.pem"
SSL_DH_FILE="/etc/apache2/ssl/dhparams.pem"
USE_SSL_CA=""

MAIL_CONTACT_ADDRESS=${MAIL_CONTACT_ADDRESS:-"no-reply@$MISP_FQDN"}

CONFIG_PART_FOR_HTTP_HTTPS="
    ServerAdmin ${MAIL_CONTACT_ADDRESS}
    ServerName ${MISP_FQDN}
    ServerAlias misp-server 127.0.0.1
    
    DocumentRoot /var/www/MISP/app/webroot
    
    <Directory /var/www/MISP/app/webroot>
        Options -Indexes
        AllowOverride all
        Order allow,deny
        allow from all
    </Directory>

    LogLevel warn

    # We have installed rsyslog which take the files and sends it to Docker stdout and stderr
    ErrorLog /var/log/apache2/error.log
    CustomLog /var/log/apache2/access.log combined

    ServerSignature Off
    # Header set X-Content-Type-Options nosniff
    # Header set X-Frame-Options DENY
"


# Functions
echo (){
    command echo "$STARTMSG $*"
}

create_dh(){
    echo "Create DH params - This can take a long time, so take a break and enjoy a cup of tea or coffee."
    openssl dhparam -out "$SSL_DH_FILE" 2048 
}

# Environment Parameter
    #



#
#   MAIN
#
echo "... Webserver configuration generation..."


# Check if Directory exists
[ -d "$HTTP_CONF_DIRECTORY" ] && mkdir -p "$HTTP_CONF_DIRECTORY"
# Check if SSL CA File exists
[ -f "$SSL_CA" ] && USE_SSL_CA="SSLCertificateChainFile ${SSL_CA}"
# Check if DH File exist, if not create one
[ ! -f "$SSL_DH_FILE" ] && create_dh

# Checkl if SSL Cert and Private Key Files exists
if [ -f "$SSL_CERT" ] && [ -f "$SSL_KEY" ]
then

# Write HTTPS File
echo "... ... Write web server https configuration..."
cat << EOF > $HTTPS_FILE

ServerTokens Prod

<VirtualHost *:443>
    ${CONFIG_PART_FOR_HTTP_HTTPS}

    SSLEngine               On
    
    # for Modern: SSLProtocol             all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLProtocol             all -SSLv2 -SSLv3
    
    # Old
    # SSLCipherSuite          ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA
    # Modern from 2019-06
    #SSLCipherSuite          ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
    # Intermediate from 2019-06
    SSLCipherSuite          ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
    
    SSLHonorCipherOrder     on
    SSLCompression          off
    SSLSessionTickets       off
    SSLOpenSSLConfCmd       DHParameters "${SSL_DH_FILE}"

    # OCSP Stapling, only in httpd 2.3.3 and later
    # SSLUseStapling          off
    # SSLStaplingResponderTimeout 5
    # SSLStaplingReturnResponderErrors off
    # SSLStaplingCache        shmcb:/var/run/ocsp(128000)

    SSLCertificateFile ${SSL_CERT}
    SSLCertificateKeyFile ${SSL_KEY}
    ${USE_SSL_CA}
</VirtualHost>


EOF

else

echo "... ... Write web server http configuration..."
# Write HTTP File
cat << EOF > $HTTP_FILE

ServerTokens Prod

<VirtualHost *:80>
    ${CONFIG_PART_FOR_HTTP_HTTPS}
</VirtualHost>


EOF

fi

#
#
# Add Ports file
echo "... ... Write web server ports file..."
cat <<EOF > $PORTS_FILE

# If you just change the port or add more ports here, you will likely also
# have to change the VirtualHost statement in
# /etc/apache2/sites-enabled/000-default.conf

Listen 80

<IfModule ssl_module>
    Listen 443
</IfModule>

<IfModule mod_gnutls.c>
    Listen 443
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet

EOF

#
#
# Add Server_Status
a2enmod status
rm /etc/apache2/mods-enabled/status.conf
ALLOWED_IP_RANGE=""
for i in $(grep -Po  '[0-9.].*/[0-9][0-9]' /proc/net/fib_trie|sort|uniq)
do
    [ "127.0.0.1" = "$i" ] && continue
    ALLOWED_IP_RANGE="${ALLOWED_IP_RANGE}${i} "
done
cat <<EOF > $SERVER_STATUS_FILE
<IfModule mod_status.c>
        # Allow server status reports generated by mod_status,
        # with the URL of http://servername/server-status
        # Uncomment and change the "192.0.2.0/24" to allow access from other hosts.

        <Location /server-status>
            SetHandler server-status
            #Require local
            Require ip $ALLOWED_IP_RANGE
            
        </Location>

        # Keep track of extended status information for each request
        ExtendedStatus On

        # Determine if mod_status displays the first 63 characters of a request or
        # the last 63, assuming the request itself is greater than 63 chars.
        # Default: Off
        #SeeRequestTail On

        <IfModule mod_proxy.c>
            # Show Proxy LoadBalancer status in mod_status
            ProxyStatus On
        </IfModule>

</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noe

EOF

# Check Permissions
echo "... ... Check webserver file permissions..."
chmod 640 /etc/apache2/ports.conf /etc/apache2/sites-available/*
chown root.root /etc/apache2/ports.conf /etc/apache2/sites-available/*

echo "... Webserver configuration generation...finished"
