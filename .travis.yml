language: minimal
dist: xenial
addons:
  apt:
    sources:
      - docker-xenial
  hosts:
  - misp.example.com

env:
  matrix:
  # Activate only Supported and Nightly Images.
  - FOLDER=2.4.nightly-ubuntu
  - FOLDER=2.4.nightly-debian ADD_TAGS="latest-dev"
  - FOLDER=2.4.88-ubuntu
  # - FOLDER=2.4.89-ubuntu
  # - FOLDER=2.4.90-ubuntu
  # - FOLDER=2.4.91-ubuntu
  # - FOLDER=2.4.92-ubuntu
  # - FOLDER=2.4.93-ubuntu
  # - FOLDER=2.4.94-ubuntu
  # - FOLDER=2.4.95-ubuntu
  # - FOLDER=2.4.96-ubuntu
  # - FOLDER=2.4.97-debian
  # - FOLDER=2.4.98-debian
  # - FOLDER=2.4.99-debian
  # - FOLDER=2.4.100-debian
  # - FOLDER=2.4.101-debia
  - FOLDER=2.4.102-debian
  - FOLDER=2.4.103-debian
  global:
  #- DOCKER_COMPOSE_VERSION=1.4.2
  - COMPONENT=server


before_script:
# Build
- export CONTAINER_NAME="$(echo $TRAVIS_REPO_SLUG | tr '[:upper:]' '[:lower:]')"
- set -xv
- docker build
    --build-arg VCS_REF="$TRAVIS_COMMIT" 
    --build-arg VERSION="$(echo $FOLDER |cut -d - -f 1)" 
    --build-arg GIT_REPO="https://github.com/$CONTAINER_NAME" 
    --build-arg COMPONENT="$COMPONENT"
    --build-arg BUILD_DATE="$(date -u +"%Y-%m-%d")"
    -t "$CONTAINER_NAME:$FOLDER-dev"
    "$TRAVIS_BUILD_DIR/$FOLDER/"
- set +xv
- docker images
# Test
#- git clone https://github.com/DCSO/MISP-dockerized.git && make -C MISP-dockerized install test=$COMPONENT folder=$FOLDER
#  if: NOT branch = master
# PUSH
- echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
- docker push "$CONTAINER_NAME:$FOLDER-dev"
- if [ -n "${ADD_TAGS}" ] then \
  for i in $ADD_TAGS; \
  do docker tag "$CONTAINER_NAME:$FOLDER-dev" "$CONTAINER_NAME:$i"; docker push "$CONTAINER_NAME:$i"; done \
  fi

# don't notify me when things fail 
#notifications:
#  email: false