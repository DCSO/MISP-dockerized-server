language: minimal
dist: xenial
addons:
  apt:
    sources:
      - docker-xenial

env:
  global:
  #- DOCKER_COMPOSE_VERSION=1.4.2
  - COMPONENT=server
  matrix:
  # Activate only Supported and Nightly Images.
  #- FOLDER=2.4.nightly-ubuntu
  - FOLDER=2.4.nightly-debian TAGS="$FOLDER-dev latest-dev"
  # - VERSION=2.4.88-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.89-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.90-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.91-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.92-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.93-ubuntu TAGS="$FOLDER-dev"
  #- FOLDER=2.4.94-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.95-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.96-ubuntu TAGS="$FOLDER-dev"
  # - VERSION=2.4.97-debian TAGS="$FOLDER-dev"
  # - VERSION=2.4.98-debian TAGS="$FOLDER-dev"
  #- FOLDER=2.4.99-debian TAGS="$FOLDER-dev"
  # - VERSION=2.4.100-debian TAGS="$FOLDER-dev"
  # - VERSION=2.4.101-debian TAGS="$FOLDER-dev"
  # - VERSION=2.4.102-debian TAGS="$FOLDER-dev"
  - FOLDER=2.4.103-debian TAGS="$FOLDER-dev"

stages:
- build and push docker image
# - Test
# - retag docker image

jobs:
  include:
    - stage: build and push docker image
      script:
        - docker build
            --build-arg VCS_REF="$TRAVIS_COMMIT" 
            --build-arg VERSION="$(echo $FOLDER |cut -d - -f 1)" 
            --build-arg GIT_REPO="https://github.com/$TRAVIS_REPO_SLUG" 
            --build-arg COMPONENT="$COMPONENT"
            --build-arg BUILD_DATE="$(date -u +"%Y-%m-%d")"
            -t "$(echo $TRAVIS_REPO_SLUG:$FOLDER-dev | tr '[:upper:]' '[:lower:]')"
            "$TRAVIS_BUILD_DIR/$FOLDER/"
        - docker images
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push "$(echo $TRAVIS_REPO_SLUG:$FOLDER-dev | tr '[:upper:]' '[:lower:]')"
    # - stage: Test
    #   if: NOT branch = master
    #   script:
    #     - git clone https://github.com/DCSO/MISP-dockerized.git
    #     - make -C MISP-dockerized install test server $FOLDER
    # - stage: retag docker image
    #   if: env(TAGS) IS NOT blank
    #   script:
    #     - docker pull "$(echo $TRAVIS_REPO_SLUG:$FOLDER-dev | tr '[:upper:]' '[:lower:]')"
    #     - for i in $TAGS; do docker tag $TRAVIS_REPO_SLUG:$FOLDER-dev $TRAVIS_REPO_SLUG:$i; docker push $TRAVIS_REPO_SLUG:$i; done


# don't notify me when things fail 
#notifications:
#  email: false