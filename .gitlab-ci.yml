image: docker:latest

services:
  - docker:dind

stages:
- test
- build

variables:
  #CONTAINER_TEST_IMAGE: my-docker-hub/$CI_PROJECT_ID:$CI_BUILD_REF_NAME_test
  # The following variables are setup via gitlab project group:
  # DOCKER_HUB_TOKEN
  # DOCKER_USERNAME
  # DOCKER_PASSWORD
  # INTERNAL_REGISTRY_HOST
  # INTERNAL_REGISTRY_USER
  # INTERNAL_REGISTRY_PW

before_script:
- apk add --no-cache make bash sudo git
- docker login -u "$INTERNAL_REGISTRY_USER" -p "$INTERNAL_REGISTRY_PW" "$INTERNAL_REGISTRY_HOST"

.test:
  stage: test
  except: 
  - master  
  script:
  - make build v=$VERSION

.build:
  stage: build
  only:
  - master
  script:
  - make build v=$VERSION
  - make tags
  - make push

include:
  - '2.4.nightly-ubuntu/.gitlab-ci.yml'
  - '2.4.88-ubuntu/.gitlab-ci.yml'
  - '2.4.89-ubuntu/.gitlab-ci.yml'
  - '2.4.90-ubuntu/.gitlab-ci.yml'
  - '2.4.91-ubuntu/.gitlab-ci.yml'
  - '2.4.92-ubuntu/.gitlab-ci.yml'
  - '2.4.93-ubuntu/.gitlab-ci.yml'
  - '2.4.94-ubuntu/.gitlab-ci.yml'
  - '2.4.95-ubuntu/.gitlab-ci.yml'
  - '2.4.96-ubuntu/.gitlab-ci.yml'
  - '2.4.97-debian/.gitlab-ci.yml'
  - '2.4.98-debian/.gitlab-ci.yml'
  - '2.4.99-debian/.gitlab-ci.yml'
